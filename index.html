<!doctype html>

<html>
  <head>
    <meta charset="utf-8">
    <script src="./d3.js"></script>
    <script src="./topojson.js"></script>

  <style>

    body {
      font-family: sans-serif;
    }
    .county:hover {
      fill: #9FD3FA;
    }

    #tooltip {
      position: absolute;
      min-width: 140px;
      min-height: 60px;
      padding: 8px;
      border-radius: 3px;
      box-shadow: 4px 4px 5px grey;
      pointer-events: none;
    }
  
  </style>

  </head>
  <body>

    <svg width="960" height="600"></svg>

  <script>
    
    let width = 960,
        height = 600

    let svg = d3.select("svg")
    let path = d3.geoPath()

    let education = d3.map()

    let tooltip = d3.select("body")
                    .append("div")
                      .attr("id", "tooltip")
                      .style("display", "none")
                      .style("background-color", '#889be0')

    //Brewer multi-hue sequential. Purple-red..
    let colors = ['#fff7f3','#fde0dd','#fcc5c0','#fa9fb5','#f768a1','#dd3497','#ae017e','#7a0177']

    let cScale = d3.scaleThreshold()
                   .domain([3,12,21,30,39,48,66])
                   .range(colors)

    Promise.all([
                  d3.csv("./for_user_education.csv"),
                  d3.json("./counties-simple.json"),
                ]
    ).then( function(values) {
     
      // Create object to be able to query data by fips ID.
      for (let stat of values[0]) {
        education.set(stat.fips, 
                      { state: stat.state, 
                        county: stat.area_name, 
                        bachelorsOrHigher: +stat.bachelorsOrHigher
                      })
      }

      svg.append("g")
          .attr("class", "usa")
        .selectAll("path")
        .data(topojson.feature(values[1], values[1].objects.counties).features)
        .enter().append("path")
        .attr("fill", function(d,i) { return cScale(+(education.get(d.id).bachelorsOrHigher)) })
          .attr("stroke", "white")
          .attr("d", path)
          .attr("class", "county")
          .attr("data-fips", (d) => (d.id))
          .attr("data-education", (d) => (education.get(d.id).bachelorsOrHigher))
          .on("mouseover", showTip)
          .on("mousemove", updateTip)
          .on("mouseout", hideTip)

    }).catch( function(error) {
      console.log("Mapping error: ", error.message)
    })

    function showTip() {
      tooltip
        .transition()
        .duration(200)
        .style("opacity", 1)
    }

    function updateTip(data) {
        tooltip
          .style("display", "inline")
          .attr("data-education", () => (education.get(data.id).bachelorsOrHigher))
          .style("top", () => (d3.event.pageY + "px"))
          .style("left", () => ( (d3.event.pageX + 20) + "px") )
        .html( education.get(data.id).county + "<br>" + 
               education.get(data.id).state + "<br>" +
               "Percentage: " + education.get(data.id).bachelorsOrHigher
            )
    }
    
    function hideTip() {
      tooltip
        .transition()
        .duration(200)
        .style("opacity", 0)
    }


  </script>
  </body>
</html>
